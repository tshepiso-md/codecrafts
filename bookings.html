<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Form</title>
    <link rel="stylesheet" href="bookings.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

table, th, td {
    border: 1px solid #ddd;
}

th, td {
    padding: 10px;
    text-align: center;
}
.cancel-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        header {
    position: fixed; /* Fix the navbar to the top */
    width: 100%; /* Full width */
    background-color: white; /* Ensure the navbar has a background color */
    z-index: 1000; /* Keep it on top of other content */
}

body {
    padding-top: 1px; /* Adjust this value based on your header height */
}
    </style>
</head>
<body>
    <header>
        
            <div class="header-content">
            <h1>Crown &amp; Polish Beauty Studio</h1>
            <nav>
                <ul>
                    <li><a href="homePage.html">home</a></li>
                    <li><a href="servicesPage.html">Services</a></li>
                    <li><a href="bookings.html">Bookings</a></li>
                    <li><a href="gallery.html">Gallery</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><button onclick="window.location.href='employeeLogin.html'" class="login-button">admin</button></li>
                    
                </ul>
            </nav>
        </div>
    </header>
    <section>
    <div class="booking-container">
        <h1>Bookings</h1>
        <div class="booking-content">
            <div class="booking-form">
                <h2>Please fill out the booking form below (you can select more than one service)</h2>
                <form id="booking-form" onsubmit="handleBookingSubmit(event)">
                    <h3>Which services would you like to book?</h3>
                    <label><input type="checkbox" name="services" value="nails" onchange="toggleStaffOptions()"> Nails</label>
                    <label><input type="checkbox" name="services" value="hair" onchange="toggleStaffOptions()"> Hair</label>
                    <label><input type="checkbox" name="services" value="facials" onchange="toggleStaffOptions()"> Facials</label>
                    <label><input type="checkbox" name="services" value="full-body-massage" onchange="toggleStaffOptions()"> Full Body Massage</label>

                   
                    <div id="nails-staff" class="service-options" style="display: none;">
                        <h4>Nails done by?</h4>
                        <label><input type="radio" name="nails" value="Sethabile"> Sethabile</label>
                        <label><input type="radio" name="nails" value="Kamogelo"> Kamogelo</label>
                        <label><input type="radio" name="nails" value="anyone"> Anyone available</label>
                    </div>

                    <div id="hair-staff" class="service-options" style="display: none;">
                        <h4>Hair done by?</h4>
                        <label><input type="radio" name="hair" value="Buhle"> Buhle</label>
                        <label><input type="radio" name="hair" value="Nkosi"> Nkosi</label>
                        <label><input type="radio" name="hair" value="anyone"> Anyone available</label>
                    </div>

                    <div id="facials-staff" class="service-options" style="display: none;">
                        <h4>Facials done by?</h4>
                        <label><input type="radio" name="facials" value="lebogang"> Lebogang</label>
                        <label><input type="radio" name="facials" value="Musa"> Musa</label>
                        <label><input type="radio" name="facials" value="anyone"> Anyone available</label>
                    </div>

                    <div id="massage-staff" class="service-options" style="display: none;">
                        <h4>Massage done by?</h4>
                        <label><input type="radio" name="massage" value="Khosi"> Khosi</label>
                        <label><input type="radio" name="massage" value="Lydia"> Lydia</label>
                        <label><input type="radio" name="massage" value="anyone"> Anyone available</label>
                    </div>
                </form>
            </div>
       
          
            <div class="booking-details">
                <h3>Select date and time</h3>
                <div class="date-time">
                    <input type="date" id="booking-date" required min="">
                    <div class="time-slots">
                        <label><input type="radio" name="time" value="09:00 AM" required> 09:00 AM</label>
                        <label><input type="radio" name="time" value="11:00 AM"> 11:00 AM</label>
                        <label><input type="radio" name="time" value="13:00 PM"> 13:00 PM</label>
                        <label><input type="radio" name="time" value="15:00 PM"> 15:00 PM</label>
                        <label><input type="radio" name="time" value="17:00 PM"> 17:00 PM</label>
                    </div>
                </div>

                <div class="login-details">
                    <h3>Username</h3>
                    <input type="text" id="username" placeholder="Enter your username" name="username" required>
                   
                  
                    <button type="button" id="book" class="book-button">BOOK</button> 
                    
                    <p>Don't have an account? <a href="#" class="signup-link" onclick="navigateToSignUp()">Sign up</a></p>
                </div>
            </div>
        </div>
    </div>
    </section>

    <section>
        <h2>bookings made</h2>
        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>Username</th>
                    <th>Service</th>
                    <th>Employee</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>action</th>
                </tr>
            </thead>
            <tbody id="bookings-container">
                
            </tbody>
        </table>
    </section>
    <script type="module">
       
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";  
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, collection, getDocs,deleteDoc,setDoc, addDoc, query, where, orderBy, limit, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

 
 const firebaseConfig = {
        apiKey: "AIzaSyC6OJmdKspro9Nb1FxwMH2PtN7WAJnKaUM",
        authDomain: "code-crafts-f5107.firebaseapp.com",
        projectId: "code-crafts-f5107",
        storageBucket: "code-crafts-f5107.appspot.com",
        messagingSenderId: "171510387289",
        appId: "1:171510387289:web:4234c82d229a80bb5d9748",
        measurementId: "G-Y9SCZHRVYZ"
      };
    

        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

 
      document.addEventListener("DOMContentLoaded", function () {
        function toggleStaffOptions() {
            const selectedServices = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(input => input.value);
            document.getElementById('nails-staff').style.display = selectedServices.includes('nails') ? 'block' : 'none';
            document.getElementById('hair-staff').style.display = selectedServices.includes('hair') ? 'block' : 'none';
            document.getElementById('facials-staff').style.display = selectedServices.includes('facials') ? 'block' : 'none';
            document.getElementById('massage-staff').style.display = selectedServices.includes('full-body-massage') ? 'block' : 'none';
        }

        document.querySelectorAll('input[name="services"]').forEach(checkbox => {
            checkbox.addEventListener("change", toggleStaffOptions);
        });
    });

        function navigateToSignUp() {
            window.location.href = 'signup.html';
        }

        document.getElementById('book').addEventListener('click', handleBookingSubmit); 

        async function handleBookingSubmit(event) {
    console.log("Booking form submitted");
    event.preventDefault();

    const services = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(input => input.value);
    const date = document.getElementById('booking-date').value;
    const time = document.querySelector('input[name="time"]:checked')?.value;
    const username = document.getElementById('username').value.trim(); 

    console.log('Username:', username);

    if (!username) {
        alert('Username is required to make a booking.');
        return; 
    }

    const bookingData = {
        services,
        date,
        time,
        username,
        staffAssigned: {
            nails: document.querySelector('input[name="nails"]:checked')?.value || null,
            hair: document.querySelector('input[name="hair"]:checked')?.value || null,
            facials: document.querySelector('input[name="facials"]:checked')?.value || null,
            massage: document.querySelector('input[name="massage"]:checked')?.value || null
        },
        status: 'pending',
        createdAt: new Date(),
        updatedAt: new Date()
    };

    try {
        await addDoc(collection(db, "appointments"), bookingData);
        alert('Booking saved successfully!');
        fetchBookedAppointments(username); 
    } catch (error) {
        console.error("Error adding document: ", error);
        alert('Error saving booking. Please try again.');
    }
}

async function fetchBookedAppointments(username) {
    try {
        if (!username) {
            throw new Error("Username is undefined.");
        }

        const bookingsRef = collection(db, 'appointments');
        const q = query(bookingsRef, where("username", "==", username));
        const querySnapshot = await getDocs(q);

        const bookingsContainer = document.getElementById('bookings-container');
        bookingsContainer.innerHTML = ''; 

        if (!querySnapshot.empty) {
            querySnapshot.forEach(doc => {
                const bookingData = doc.data();
                const bookingElement = document.createElement('tr');

                const assignedStaff = Object.entries(bookingData.staffAssigned)
                    .filter(([service, staff]) => staff !== null)
                    .map(([service, staff]) => `${service.charAt(0).toUpperCase() + service.slice(1)} by: ${staff}`)
                    .join(', ');

                bookingElement.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${bookingData.username}</td>
                    <td>${bookingData.services.join(', ')}</td>
                    <td>${assignedStaff || 'None'}</td>
                    <td>${bookingData.date}</td>
                    <td>${bookingData.time}</td>
                    <td>${bookingData.status}</td>
                    <td><button class="cancel-btn" data-id="${doc.id}">Cancel</button></td> <!-- Add Cancel Button -->
                `;

                bookingsContainer.appendChild(bookingElement);
            });

           
            const cancelButtons = document.querySelectorAll('.cancel-btn');
            cancelButtons.forEach(button => {
                button.addEventListener('click', cancelBooking);
            });
        } else {
            bookingsContainer.innerHTML = '<tr><td colspan="8">No appointments found.</td></tr>';
        }
    } catch (error) {
        console.error("Error fetching appointments: ", error);
        alert('Error fetching appointments: ' + error.message);
    }
}

async function cancelBooking(event) {
    const bookingId = event.target.dataset.id; 

    try {
        const bookingDocRef = doc(db, 'appointments', bookingId);
        await updateDoc(bookingDocRef, { status: 'canceled' }); 
        alert('Booking canceled successfully!');

        
        const username = document.getElementById('username').value; 
        fetchBookedAppointments(username);
    } catch (error) {
        console.error("Error canceling booking: ", error);
        alert('Error canceling booking: ' + error.message);
    }
}


document.addEventListener("DOMContentLoaded", function () {
        const today = new Date();
        const minDate = today.toISOString().split("T")[0];
        document.getElementById("booking-date").setAttribute("min", minDate);

        document.getElementById("booking-date").addEventListener("input", function () {
            const selectedDate = new Date(this.value);
            const selectedYear = selectedDate.getFullYear();

            if (selectedYear < today.getFullYear()) {
                alert("Please select a valid date.");
                this.value = "";
            }
        });
    });
    </script>
</body>
</html>
