<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Form</title>
    <link rel="stylesheet" href="bookings.css">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

table, th, td {
    border: 1px solid #ddd;
}

th, td {
    padding: 10px;
    text-align: center;
}
.cancel-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        header {
    position: fixed; /* Fix the navbar to the top */
    width: 100%; /* Full width */
    background-color: white; /* Ensure the navbar has a background color */
    z-index: 1000; /* Keep it on top of other content */
}

body {
    padding-top: 1px; /* Adjust this value based on your header height */
}
.search-container {
    display: flex;
    justify-content: flex-end; /* Aligns the content (input and button) to the right */
    margin-bottom: 20px;
}

.search-container input {
    padding: 10px;
    margin-right: 10px; /* Space between the input and the button */
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 250px; /* Adjust the width of the input field */
}
    </style>
</head>
<body>
    <header>
        
            <div class="header-content">
            <h1>Crown &amp; Polish Beauty Studio</h1>
            <nav>
                <ul>
                    <li><a href="homePage.html">Home</a></li>
                    <li><a href="servicesPage.html">Services</a></li>
                    <li><a href="bookings.html">Bookings</a></li>
                    <li><a href="gallery.html">Gallery</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><button onclick="window.location.href='employeeLogin.html'" class="login-button">admin</button></li>
                    
                </ul>
            </nav>
        </div>
    </header>
    <section>
    <div class="booking-container">
        <h1>Bookings</h1>
        <div class="booking-content">
            <div class="booking-form">
                <h2>Please fill out the booking form below (you can select more than one service)</h2>
                <form id="booking-form" onsubmit="handleBookingSubmit(event)">
                    <h3>Which services would you like to book?</h3>
                    <label><input type="checkbox" name="services" value="nails" onchange="toggleStaffOptions()"> Nails</label>
                    <label><input type="checkbox" name="services" value="hair" onchange="toggleStaffOptions()"> Hair</label>
                    <label><input type="checkbox" name="services" value="facials" onchange="toggleStaffOptions()"> Facials</label>
                    <label><input type="checkbox" name="services" value="full-body-massage" onchange="toggleStaffOptions()"> Full Body Massage</label>

                   
                    <div id="nails-staff" class="service-options" style="display: none;"></div>
                    <div id="hair-staff" class="service-options" style="display: none;"></div>
                    <div id="facials-staff" class="service-options" style="display: none;"></div>
                    <div id="full-body-massage-staff" class="service-options" style="display: none;"></div>
                    
                </form>
            </div>
       
          
            <div class="booking-details">
                <h3>Select date and time</h3>
                <div class="date-time">
                    <input type="date" id="booking-date" required min="">
                    <div class="time-slots">
                        <label><input type="radio" name="time" value="09:00 AM" required> 09:00 AM</label>
                        <label><input type="radio" name="time" value="11:00 AM"> 11:00 AM</label>
                        <label><input type="radio" name="time" value="13:00 PM"> 13:00 PM</label>
                        <label><input type="radio" name="time" value="15:00 PM"> 15:00 PM</label>
                        <label><input type="radio" name="time" value="17:00 PM"> 17:00 PM</label>
                    </div>
                </div>

                <div class="login-details">
                    <h3>Username</h3>
                    <input type="text" id="username" placeholder="Enter your username" name="username" required>
                   
                  
                    <button type="button" id="book" class="book-button">BOOK</button> 
                    
                    <p>Don't have an account? <a href="#" class="signup-link" onclick="navigateToSignUp()">Sign up</a></p>
                </div>
            </div>
        </div>
    </div>
    </section>

    <section>
        <h2>bookings made</h2>

        <div class="search-container">
            <input type="text" id="search-username" placeholder="Search by username">
        </div>

        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>Username</th>
                    <th>Service</th>
                    <th>Employee</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>action</th>
                </tr>
            </thead>
            <tbody id="bookings-container">
                
            </tbody>
        </table>
    </section>
    <footer>
        <div class="container">
            <div class="social-links">
                <a href="https://www.instagram.com/crownandpolishbeauty?igsh=N3BzbWJ1dmt4c2I1">Instagram</a>
                <a href="https://www.tiktok.com/@sharonmotsepe0?_t=8qxMDaRQF4o&_r=1">TikTok</a>
                <a href="https://www.facebook.com/share/xo6aZJG7rPPtPp2g/">Facebook</a>
            </div>
            <div class="footer-info">
                <ul>
                    <li><p>&copy; Crown and Beauty </p></li>
                    <li><p>designed and developed by codecrafts</p></li>
             </ul>
                <div class="footer-pages">
                    <h4>Pages</h4>
                    <ul>
                        <li><a href="homePage.html">Home</a></li>
                        <li><a href="servicesPage.html">Services</a></li>
                        <li><a href="bookings.html">Bookings</a></li>
                        <li><a href="gallery.html">Gallery</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-address">
                    <p>Address</p>
                    <p>3 Waterford Pl, Kleve Hill Park<br>Sandton, Johannesburg<br>Gauteng <br>South Africa </p>
                </div>
            </div>
        </div>
    </footer>
    <script type="module">
       
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";  
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, collection, getDocs,deleteDoc,setDoc, addDoc, query, where, orderBy, limit, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

 
 const firebaseConfig = {
        apiKey: "AIzaSyC6OJmdKspro9Nb1FxwMH2PtN7WAJnKaUM",
        authDomain: "code-crafts-f5107.firebaseapp.com",
        projectId: "code-crafts-f5107",
        storageBucket: "code-crafts-f5107.appspot.com",
        messagingSenderId: "171510387289",
        appId: "1:171510387289:web:4234c82d229a80bb5d9748",
        measurementId: "G-Y9SCZHRVYZ"
      };
    

        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

 
        document.addEventListener("DOMContentLoaded", function () {
    // Listen for checkbox changes and dynamically show staff options
    function toggleStaffOptions() {
        const selectedServices = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(input => input.value);

        // Clear previous staff options
        selectedServices.forEach(service => {
            loadEmployeesByService(service); // Load employees specific to each selected service
        });

        // Toggle visibility based on selected services
        document.getElementById('nails-staff').style.display = selectedServices.includes('nails') ? 'block' : 'none';
        document.getElementById('hair-staff').style.display = selectedServices.includes('hair') ? 'block' : 'none';
        document.getElementById('facials-staff').style.display = selectedServices.includes('facials') ? 'block' : 'none';
        document.getElementById('full-body-massage-staff').style.display = selectedServices.includes('full-body-massage') ? 'block' : 'none';
    }

    // Bind checkbox change events
    document.querySelectorAll('input[name="services"]').forEach(checkbox => {
        checkbox.addEventListener("change", toggleStaffOptions);
    });
});

        function navigateToSignUp() {
            window.location.href = 'signup.html';
        }

        document.getElementById('book').addEventListener('click', handleBookingSubmit); 

        async function handleBookingSubmit(event) {
    console.log("Booking form submitted");
    event.preventDefault();

    const services = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(input => input.value);
    const date = document.getElementById('booking-date').value;
    const time = document.querySelector('input[name="time"]:checked')?.value;
    const username = document.getElementById('username').value.trim(); 

    console.log('Username:', username);

    if (!username) {
        alert('Username is required to make a booking.');
        return; 
    }

    const bookingData = {
    services,
    date,
    time,
    username,
    staffAssigned: {
        nails: document.querySelector('input[name="nails"]:checked')?.value || null,
        hair: document.querySelector('input[name="hair"]:checked')?.value || null,
        facials: document.querySelector('input[name="facials"]:checked')?.value || null,
        massage: document.querySelector('input[name="full-body-massage"]:checked')?.value || null, // Fixed here
    },
    status: 'pending',
    createdAt: new Date(),
    updatedAt: new Date()
};

    try {
        await addDoc(collection(db, "appointments"), bookingData);
        alert('Booking saved successfully!');
        fetchBookedAppointments(username); 
    } catch (error) {
        console.error("Error adding document: ", error);
        alert('Error saving booking. Please try again.');
    }
}

async function fetchBookedAppointments(username) {
    try {
        if (!username) {
            throw new Error("Username is undefined.");
        }

        const bookingsRef = collection(db, 'appointments');
        const q = query(bookingsRef, where("username", "==", username));
        const querySnapshot = await getDocs(q);

        const bookingsContainer = document.getElementById('bookings-container');
        bookingsContainer.innerHTML = ''; 

        if (!querySnapshot.empty) {
            querySnapshot.forEach(doc => {
                const bookingData = doc.data();
                const bookingElement = document.createElement('tr');

                const assignedStaff = Object.entries(bookingData.staffAssigned)
    .filter(([service, staff]) => staff !== null)
    .map(([service, staff]) => `${service.charAt(0).toUpperCase() + service.slice(1)} by: ${staff}`)
    .join(', ');

                bookingElement.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${bookingData.username}</td>
                    <td>${bookingData.services.join(', ')}</td>
                    <td>${assignedStaff || 'None'}</td>
                    <td>${bookingData.date}</td>
                    <td>${bookingData.time}</td>
                    <td>${bookingData.status}</td>
                    <td><button class="cancel-btn" data-id="${doc.id}">Cancel</button></td> <!-- Add Cancel Button -->
                `;

                bookingsContainer.appendChild(bookingElement);
            });

           
            const cancelButtons = document.querySelectorAll('.cancel-btn');
            cancelButtons.forEach(button => {
                button.addEventListener('click', cancelBooking);
            });
        } else {
            bookingsContainer.innerHTML = '<tr><td colspan="8">No appointments found.</td></tr>';
        }
    } catch (error) {
        console.error("Error fetching appointments: ", error);
        alert('Error fetching appointments: ' + error.message);
    }
}

async function cancelBooking(event) {
    const bookingId = event.target.dataset.id; 

    try {
        const bookingDocRef = doc(db, 'appointments', bookingId);
        await updateDoc(bookingDocRef, { status: 'canceled' }); 
        alert('Booking canceled successfully!');

        
        const username = document.getElementById('username').value; 
        fetchBookedAppointments(username);
    } catch (error) {
        console.error("Error canceling booking: ", error);
        alert('Error canceling booking: ' + error.message);
    }
}


document.addEventListener("DOMContentLoaded", function () {
        const today = new Date();
        const minDate = today.toISOString().split("T")[0];
        document.getElementById("booking-date").setAttribute("min", minDate);

        document.getElementById("booking-date").addEventListener("input", function () {
            const selectedDate = new Date(this.value);
            const selectedYear = selectedDate.getFullYear();

            if (selectedYear < today.getFullYear()) {
                alert("Please select a valid date.");
                this.value = "";
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
    function searchByUsername() {
        const username = document.getElementById('search-username').value.trim();

        if (username) {
            fetchBookedAppointments(username);
        } else {
            alert("Please enter a username to search.");
        }
    }

    document.getElementById('search-username').addEventListener('input', searchByUsername);
});

// Fetch employees based on the selected service from Firestore
async function loadEmployeesByService(serviceType) {
    const employeesRef = collection(db, 'employees');
    const q = query(employeesRef, where("services", "array-contains", serviceType)); // Assuming `services` is an array field in Firestore
    const querySnapshot = await getDocs(q);

    const employees = [];
    querySnapshot.forEach(doc => {
        const employee = doc.data();
        employees.push(`${employee.firstName} ${employee.lastName}`);
    });

    populateEmployeeOptions(serviceType, employees);
}

// Populate the staff options dynamically in the form
function populateEmployeeOptions(service, employees) {
    const serviceStaffDiv = document.getElementById(`${service}-staff`);
    if (serviceStaffDiv) {
        serviceStaffDiv.innerHTML = `
            <h4>${service.charAt(0).toUpperCase() + service.slice(1)} done by?</h4>
            ${employees.map(emp => `<label><input type="radio" name="${service}" value="${emp}"> ${emp}</label>`).join('') || '<p>No employees available</p>'}
            <label><input type="radio" name="${service}" value="anyone"> Anyone available</label>
        `;
    }
}
    </script>
</body>
</html>
